<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oink-O-Clock Jump Battle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background: #0f172a;
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        canvas {
            display: block;
            image-rendering: antialiased;
        }
        .ui-layer { pointer-events: none; }
        .ui-layer button, .ui-layer .clickable { pointer-events: auto; }
        .card-item { cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .card-item:hover { transform: scale(1.02); background: rgba(255, 255, 255, 0.05); }
        .searching-dots::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80% { content: '...'; } }
        .customize-hint { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="game-container" class="relative shadow-2xl overflow-hidden border-4 border-indigo-900 rounded-3xl bg-indigo-950" style="width: 400px; height: 700px;">
        <canvas id="gameCanvas" width="400" height="700"></canvas>
        
        <!-- Home Screen -->
        <div id="ui-home" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950/80 backdrop-blur-sm z-40 text-white p-6 text-center">
            <!-- Stats & Presence Pills -->
            <div class="absolute top-6 left-6 flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/5">
                <div class="flex flex-col items-start leading-tight">
                    <span class="text-[9px] uppercase font-black text-white/40 tracking-tighter">Combat Records</span>
                    <div class="text-[11px] font-black flex items-center gap-2">
                        <span class="text-green-400">W: <span id="stat-wins">0</span></span>
                        <span class="text-red-400">L: <span id="stat-losses">0</span></span>
                    </div>
                </div>
            </div>
            <div class="absolute top-6 right-6 flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/5">
                <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                <div class="text-[11px] font-black text-white"><span id="online-count-val">1</span> <span class="text-[8px] opacity-60 ml-0.5 tracking-tighter uppercase">Pigs Online</span></div>
            </div>

            <div class="mb-2">
                <h1 class="text-5xl font-black mb-1 tracking-tighter text-pink-400 drop-shadow-lg leading-none">OINK BATTLE</h1>
                <p class="text-pink-300/60 font-bold tracking-widest text-[10px] uppercase">Online Swine Showdown</p>
            </div>

            <div id="home-avatar-container" class="relative group cursor-pointer mb-2 active:scale-90 transition-transform">
                <div class="absolute -inset-4 bg-pink-500/10 rounded-full blur-xl group-hover:bg-pink-500/20 transition-colors"></div>
                <canvas id="home-avatar-preview" width="120" height="120" class="relative"></canvas>
                <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-black/60 px-3 py-1 rounded-full border border-white/10 text-[8px] font-black uppercase tracking-widest customize-hint">Tap to Customize</div>
            </div>
            
            <div class="flex flex-col gap-2 w-64 items-center">
                <button id="btn-battle" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-3 rounded-2xl text-lg transition-all active:scale-95 shadow-xl flex flex-col items-center leading-none">
                    <span>DEATHMATCH</span>
                    <span class="text-[8px] opacity-60 mt-1 uppercase tracking-tighter">Last Pig Standing</span>
                </button>
                <div class="flex gap-2 w-full">
                    <button id="btn-timed-battle" class="flex-1 bg-pink-600 hover:bg-pink-500 text-white font-black py-3 rounded-2xl text-xs transition-all active:scale-95 shadow-xl uppercase border-b-4 border-pink-800">Timed</button>
                    <button id="btn-surge-battle" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-black py-3 rounded-2xl text-xs transition-all active:scale-95 shadow-xl uppercase border-b-4 border-purple-800">Surge</button>
                </div>
                
                <div class="flex gap-2 w-full">
                    <button id="btn-solo" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-black py-2.5 rounded-2xl text-[10px] transition-all active:scale-95 shadow-xl uppercase tracking-widest">Solo Run</button>
                    <button id="btn-vs-ai" class="flex-1 bg-cyan-700 hover:bg-cyan-600 text-white font-black py-2.5 rounded-2xl text-[10px] transition-all active:scale-95 shadow-xl uppercase tracking-widest flex items-center justify-center gap-1.5">
                        <span class="text-xs">ü§ñ</span> VS BOT
                    </button>
                </div>
                
                <div class="grid grid-cols-3 gap-2 w-full mt-1">
                    <button id="btn-skins" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl text-[10px] uppercase">SKINS</button>
                    <button id="btn-hats" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl text-[10px] uppercase">HATS</button>
                    <button id="btn-themes" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl text-[10px] uppercase">THEMES</button>
                </div>
            </div>

            <div class="mt-4 group cursor-pointer" id="div-username">
                <div id="display-username" class="text-pink-400 font-black text-xs group-hover:underline">Identify Yourself</div>
            </div>
        </div>

        <!-- Popups, HUD, Overlays remain similar to previous state but with pig-themed names -->
        <div id="ui-matchmaking" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950/95 z-[60] text-white p-8 text-center hidden">
            <div class="w-24 h-24 mb-6 relative">
                <div class="absolute inset-0 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-4xl">üê∑</div>
            </div>
            <h2 id="matchmaking-mode-label" class="text-2xl font-black mb-2 uppercase italic searching-dots">Finding Rival</h2>
            <button id="btn-cancel-match" class="text-[10px] font-bold text-white/30 hover:text-white uppercase tracking-widest border border-white/10 px-6 py-2 rounded-full">Cancel</button>
        </div>

        <div id="ui-battle-start" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950 z-[70] text-white hidden">
            <div id="battle-mode-header" class="mb-8 bg-pink-600/20 px-4 py-1 rounded text-xs font-black uppercase tracking-widest text-pink-400 border border-pink-500/30">DEATHMATCH</div>
            <div class="flex items-center gap-8 mb-8">
                <div class="flex flex-col items-center"><canvas id="p1-preview" width="64" height="64" class="mb-2"></canvas><span id="p1-name" class="font-black text-sm uppercase">YOU</span></div>
                <div class="text-4xl font-black italic text-pink-500">VS</div>
                <div class="flex flex-col items-center"><canvas id="p2-preview" width="64" height="64" class="mb-2"></canvas><span id="p2-name" class="font-black text-sm uppercase">RIVAL</span></div>
            </div>
            <h2 id="battle-countdown" class="text-6xl font-black italic">3</h2>
        </div>

        <div id="ui-hud" class="absolute top-0 left-0 right-0 p-4 flex justify-between ui-layer text-white hidden">
            <div class="bg-black/40 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/5"><div class="text-[8px] font-bold uppercase opacity-60">YOU</div><div id="score-val" class="text-3xl font-black text-pink-400 leading-none">0</div></div>
            <div id="opponent-hud" class="bg-black/40 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/5 text-right hidden"><div id="opponent-label" class="text-[8px] font-bold uppercase opacity-60">RIVAL</div><div id="opponent-score-val" class="text-3xl font-black text-indigo-400 leading-none">0</div></div>
        </div>

        <div id="ui-gameover" class="absolute inset-0 flex flex-col items-center justify-center bg-red-950/90 backdrop-blur-md z-[55] text-white p-6 text-center hidden">
            <h2 id="battle-result" class="text-5xl font-black mb-1 uppercase tracking-tighter italic">GAME OVER</h2>
            <div class="text-7xl font-black text-pink-400 mb-2" id="final-score">0</div>
            <button id="btn-go-home" class="bg-white text-indigo-900 font-black py-4 px-12 rounded-xl text-2xl w-64 active:scale-95 transition-transform uppercase">HOME</button>
        </div>

        <div id="ui-username" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950/95 z-[60] text-white p-6 text-center hidden">
            <h2 class="text-2xl font-black mb-2 uppercase italic">IDENTIFY YOURSELF</h2>
            <input type="text" id="username-input" maxlength="12" placeholder="OINK-NAME" class="w-64 bg-indigo-900 border-2 border-pink-500/30 text-white text-center py-3 rounded-xl font-bold mb-4 focus:outline-none focus:border-pink-500">
            <button id="btn-save-username" class="bg-pink-500 text-white font-black py-3 px-12 rounded-xl text-lg w-64 uppercase">OINK!</button>
        </div>
        
        <!-- Customization grids (Hidden) -->
        <div id="ui-skins" class="absolute inset-0 flex flex-col bg-indigo-950 z-50 text-white p-6 hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-black italic tracking-tighter">SKINS</h2><button id="btn-close-skins">‚úï</button></div><div id="skins-grid" class="flex-1 overflow-y-auto space-y-2"></div></div>
        <div id="ui-hats" class="absolute inset-0 flex flex-col bg-indigo-950 z-50 text-white p-6 hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-black italic tracking-tighter">HATS</h2><button id="btn-close-hats">‚úï</button></div><div id="hats-grid" class="flex-1 overflow-y-auto space-y-2"></div></div>
        <div id="ui-themes" class="absolute inset-0 flex flex-col bg-indigo-950 z-50 text-white p-6 hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-black italic tracking-tighter">THEMES</h2><button id="btn-close-themes">‚úï</button></div><div id="themes-grid" class="flex-1 overflow-y-auto space-y-2"></div></div>
    </div>

    <script>
        const BOT_NAMES = ["MasterBoter", "BottyMcBotface", "PiggySmalls", "HogRider", "Sir Oinks-a-Lot", "Chris P. Bacon", "Hamlet", "Baconator", "Porkchop", "Squealer", "Boar King", "CyberSow", "IronSnout", "OinkBot-3000", "BionicBacon"];
        
        const firebaseConfig = {
            apiKey: "AIzaSyBoNeemu9G-sBKPemDxelpCPOuiTZHLyhg",
            authDomain: "gahoot-41e25.firebaseapp.com",
            databaseURL: "https://gahoot-41e25-default-rtdb.firebaseio.com",
            projectId: "gahoot-41e25",
            storageBucket: "gahoot-41e25.firebasestorage.app",
            messagingSenderId: "174472575019",
            appId: "1:174472575019:web:3bd927907334d2ffe1526e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const presenceRef = db.ref('presence');
        db.ref('.info/connected').on('value', snap => {
            if (snap.val() === true) { const con = presenceRef.push(); con.onDisconnect().remove(); con.set({ ts: Date.now(), u: localStorage.getItem('oinkUser') || 'anon' }); }
        });
        presenceRef.on('value', snap => { const el = document.getElementById('online-count-val'); if (el) el.innerText = snap.numChildren(); });

        const WIDTH = 400; const HEIGHT = 700; const CLOCK_SPACING = 260; const JUMP_SPEED = 14;
        const CLOCK_COLORS = ['#F472B6', '#60A5FA', '#34D399', '#FBBF24', '#A78BFA', '#FB923C'];
        const SKINS = [
            { id: 'classic', body: '#F472B6', ears: '#EC4899', snout: '#F9A8D4' },
            { id: 'neon', body: '#000000', ears: '#3B82F6', snout: '#60A5FA' },
            { id: 'gold', body: '#FBBF24', ears: '#D97706', snout: '#FDE68A' },
            { id: 'cyber', body: '#cbd5e1', ears: '#1e293b', snout: '#22d3ee' }
        ];
        const THEMES = [{ id: 'classic', bg: '#0f172a' }, { id: 'synthwave', bg: '#1a0b2e' }];
        const HATS = [{id:'none'}, {id:'tophat'}, {id:'propeller'}, {id:'halo'}];

        let state = {
            status: 'HOME', isMultiplayer: false, isBotActive: false, roomId: null, score: 0,
            username: localStorage.getItem('oinkUser') || '',
            selectedSkinId: localStorage.getItem('oinkSkin') || 'classic',
            selectedHatId: localStorage.getItem('oinkHatSelected') || 'none',
            selectedThemeId: localStorage.getItem('oinkTheme') || 'classic',
            wins: parseInt(localStorage.getItem('oinkWins')) || 0,
            losses: parseInt(localStorage.getItem('oinkLosses')) || 0,
            pig: { x: 200, y: 550, vx: 0, vy: 0, attachedTo: 0, angle: -Math.PI/2, isDead: false },
            bot: { x: 200, y: 550, vx: 0, vy: 0, attachedTo: 0, angle: -Math.PI/2, isDead: false, score: 0, jumpCooldown: 0, name: "" },
            opponent: { x: 200, y: 550, score: 0, status: 'playing', skin: 'classic', hat: 'none', name: "" },
            clocks: [], cameraY: 0, lastTime: 0, matchProcessed: false, voidY: HEIGHT + 200
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const homeAvatarCtx = document.getElementById('home-avatar-preview').getContext('2d');

        function playSound(f) {
            if(!window.audioCtx) window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const o = window.audioCtx.createOscillator(); const g = window.audioCtx.createGain();
            o.connect(g); g.connect(window.audioCtx.destination);
            o.frequency.setValueAtTime(f, window.audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, window.audioCtx.currentTime + 0.1);
            o.start(); o.stop(window.audioCtx.currentTime + 0.1);
        }

        function drawPigAvatar(pctx, skin, x, y, scale = 1, rotation = 0, hatId = 'none') {
            pctx.save(); pctx.translate(x, y); pctx.scale(scale, scale); pctx.rotate(rotation);
            pctx.fillStyle = skin.body; pctx.beginPath(); pctx.ellipse(0, 0, 18, 16, 0, 0, Math.PI*2); pctx.fill();
            pctx.fillStyle = skin.ears; pctx.beginPath(); pctx.moveTo(-14, -10); pctx.lineTo(-18, -20); pctx.lineTo(-6, -14); pctx.fill();
            pctx.beginPath(); pctx.moveTo(14, -10); pctx.lineTo(18, -20); pctx.lineTo(6, -14); pctx.fill();
            pctx.fillStyle = skin.snout; pctx.beginPath(); pctx.ellipse(0, 4, 8, 6, 0, 0, Math.PI*2); pctx.fill();
            pctx.fillStyle = 'black'; pctx.beginPath(); pctx.arc(-7, -4, 2.5, 0, Math.PI*2); pctx.fill(); pctx.beginPath(); pctx.arc(7, -4, 2.5, 0, Math.PI*2); pctx.fill();
            if (hatId === 'propeller') {
                pctx.fillStyle = '#ef4444'; pctx.beginPath(); pctx.arc(0, -14, 8, Math.PI, 0); pctx.fill();
                pctx.save(); pctx.translate(0, -22); pctx.rotate((Date.now()/100) % (Math.PI*2)); pctx.fillStyle = '#fbbf24'; pctx.fillRect(-12, -1, 24, 2); pctx.restore();
            }
            pctx.restore();
        }

        function drawNameLabel(pctx, name, x, y, color = '#fff') {
            pctx.save();
            pctx.font = 'black 9px Inter';
            const width = pctx.measureText(name).width;
            pctx.fillStyle = 'rgba(0,0,0,0.6)';
            pctx.beginPath();
            pctx.roundRect(x - width/2 - 6, y - 10, width + 12, 14, 7);
            pctx.fill();
            pctx.fillStyle = color;
            pctx.textAlign = 'center';
            pctx.fillText(name.toUpperCase(), x, y);
            pctx.restore();
        }

        function backToHome() {
            state.status = 'HOME'; state.clocks = []; state.score = 0; state.cameraY = 0; state.matchProcessed = false;
            if (state.roomId) { db.ref('rooms/' + state.roomId).off(); state.roomId = null; }
            document.getElementById('ui-home').classList.remove('hidden');
            ['ui-hud', 'ui-gameover', 'ui-matchmaking', 'ui-battle-start'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        function startGame() {
            state.status = 'PLAYING'; state.score = 0; state.cameraY = 0; state.matchProcessed = false;
            state.pig = { x: 200, y: HEIGHT-150-60, vx: 0, vy: 0, attachedTo: 0, angle: -Math.PI/2, isDead: false };
            if (state.isBotActive) {
                state.bot = { x: 200, y: HEIGHT-150-60, vx: 0, vy: 0, attachedTo: 0, angle: -Math.PI/2, isDead: false, score: 0, jumpCooldown: 0, name: BOT_NAMES[Math.floor(Math.random() * BOT_NAMES.length)] };
            }
            if (!state.isMultiplayer) {
                state.clocks = [{ id: 0, x: 200, y: HEIGHT-150, radius: 60, speed: 0.04, color: CLOCK_COLORS[0], angle: -Math.PI/2 }];
                for(let i=1; i<500; i++) {
                    const r = 35 + Math.random() * 50;
                    state.clocks.push({ id: i, x: r + 20 + Math.random()*(WIDTH - r*2 - 40), y: HEIGHT-150-i*CLOCK_SPACING, radius: r, angle: -Math.PI/2, speed: (0.04 + (i*0.0005)) * (60/r) * (i%2?1:-1), color: CLOCK_COLORS[i%6] });
                }
            }
            document.getElementById('ui-hud').classList.remove('hidden');
            document.getElementById('ui-home').classList.add('hidden');
        }

        async function startMatchmaking(mode) {
            if(!state.username) return document.getElementById('ui-username').classList.remove('hidden');
            state.status = 'MATCHMAKING'; document.getElementById('ui-matchmaking').classList.remove('hidden');
            const roomCode = "room_" + state.username + "_" + Date.now().toString().slice(-4);
            state.roomId = roomCode;
            db.ref('rooms/' + roomCode).set({ p1: { name: state.username, skin: state.selectedSkinId, score: 0, status: 'playing' }, status: 'waiting' });
            db.ref('rooms/' + roomCode).on('value', snap => {
                const data = snap.val(); if(data && data.status === 'playing') startBattle(roomCode);
            });
            // Simplified matchmaking simulation for demo
            setTimeout(async () => {
                if(state.status === 'MATCHMAKING') {
                    await db.ref('rooms/' + roomCode).update({ p2: { name: "RIVAL_PIG", skin: 'cyber', score: 0, status: 'playing' }, status: 'playing' });
                }
            }, 2000);
        }

        function startBattle(rc) {
            state.isMultiplayer = true; document.getElementById('ui-battle-start').classList.remove('hidden');
            document.getElementById('ui-matchmaking').classList.add('hidden');
            let count = 3;
            const itv = setInterval(() => {
                count--; document.getElementById('battle-countdown').innerText = count > 0 ? count : "OINK!";
                if(count < 0) { clearInterval(itv); document.getElementById('ui-battle-start').classList.add('hidden'); startGame(); }
            }, 1000);
        }

        function update(ts) {
            if(state.status !== 'PLAYING') return;
            state.clocks.forEach(c => c.angle += c.speed * ts);
            
            // Pig physics
            if(!state.pig.isDead) {
                if(state.pig.attachedTo !== null) {
                    const c = state.clocks.find(cl => cl.id === state.pig.attachedTo);
                    state.pig.x = c.x + Math.cos(c.angle) * c.radius; state.pig.y = c.y + Math.sin(c.angle) * c.radius;
                } else {
                    state.pig.x += state.pig.vx * ts; state.pig.y += state.pig.vy * ts;
                    for(const c of state.clocks) if(Math.sqrt((state.pig.x-c.x)**2 + (state.pig.y-c.y)**2) < c.radius + 10) {
                        state.pig.attachedTo = c.id; if(c.id > state.score) { state.score = c.id; document.getElementById('score-val').innerText = state.score; }
                        break;
                    }
                }
                if(state.pig.y > state.cameraY + HEIGHT + 100) gameOver();
            }

            // Bot physics
            if(state.isBotActive && !state.bot.isDead) {
                if(state.bot.attachedTo !== null) {
                    const c = state.clocks.find(cl => cl.id === state.bot.attachedTo);
                    const n = state.clocks.find(cl => cl.id === state.bot.score + 1);
                    if(n) {
                        const target = Math.atan2(n.y - c.y, n.x - c.x);
                        let diff = Math.abs(c.angle % (Math.PI*2) - target % (Math.PI*2));
                        if(diff > Math.PI) diff = Math.PI*2 - diff;
                        if(diff < 0.15 && state.bot.jumpCooldown <= 0) {
                            state.bot.vx = Math.cos(c.angle) * JUMP_SPEED; state.bot.vy = Math.sin(c.angle) * JUMP_SPEED;
                            state.bot.attachedTo = null; state.bot.jumpCooldown = 30;
                        }
                    }
                    if(state.bot.attachedTo !== null) { state.bot.x = c.x + Math.cos(c.angle) * c.radius; state.bot.y = c.y + Math.sin(c.angle) * c.radius; }
                } else {
                    state.bot.x += state.bot.vx * ts; state.bot.y += state.bot.vy * ts;
                    for(const c of state.clocks) if(Math.sqrt((state.bot.x-c.x)**2 + (state.bot.y-c.y)**2) < c.radius + 10) {
                        state.bot.attachedTo = c.id; state.bot.score = Math.max(state.bot.score, c.id);
                        document.getElementById('opponent-score-val').innerText = state.bot.score; break;
                    }
                }
                if(state.bot.jumpCooldown > 0) state.bot.jumpCooldown -= ts;
                if(state.bot.y > state.cameraY + HEIGHT + 100) state.bot.isDead = true;
            }

            state.cameraY += (state.pig.y - HEIGHT/2 - state.cameraY) * 0.1 * ts;
        }

        function gameOver() {
            state.pig.isDead = true; state.status = 'GAMEOVER';
            document.getElementById('final-score').innerText = state.score;
            document.getElementById('ui-gameover').classList.remove('hidden');
        }

        function draw() {
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,WIDTH,HEIGHT);
            if(state.status === 'HOME') { drawPigAvatar(homeAvatarCtx, SKINS[0], 60, 60, 2.5, Math.sin(Date.now()/500)*0.1); return; }
            
            ctx.save(); ctx.translate(0, -state.cameraY);
            state.clocks.forEach(c => {
                ctx.beginPath(); ctx.arc(c.x, c.y, c.radius, 0, Math.PI*2); ctx.strokeStyle = c.color; ctx.lineWidth = 5; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x, c.y); ctx.lineTo(c.x + Math.cos(c.angle)*c.radius, c.y + Math.sin(c.angle)*c.radius); ctx.stroke();
            });
            
            if(!state.pig.isDead) {
                drawPigAvatar(ctx, SKINS.find(s=>s.id===state.selectedSkinId), state.pig.x, state.pig.y, 1, 0, state.selectedHatId);
                drawNameLabel(ctx, state.username || "YOU", state.pig.x, state.pig.y - 32, '#f472b6');
            }
            if(state.isBotActive && !state.bot.isDead) {
                ctx.globalAlpha = 0.7;
                drawPigAvatar(ctx, SKINS[3], state.bot.x, state.bot.y, 1, 0, 'propeller');
                drawNameLabel(ctx, state.bot.name, state.bot.x, state.bot.y - 32, '#22d3ee');
                ctx.globalAlpha = 1.0;
            }
            ctx.restore();
        }

        function loop(t) { if(!state.lastTime) state.lastTime = t; update((t - state.lastTime)/16.6); state.lastTime = t; draw(); requestAnimationFrame(loop); }
        
        canvas.onclick = () => { if(state.status === 'PLAYING' && state.pig.attachedTo !== null) { 
            const c = state.clocks.find(cl => cl.id === state.pig.attachedTo);
            state.pig.vx = Math.cos(c.angle) * JUMP_SPEED; state.pig.vy = Math.sin(c.angle) * JUMP_SPEED;
            state.pig.attachedTo = null; playSound(440);
        }};
        
        document.getElementById('btn-solo').onclick = () => { state.isMultiplayer = false; state.isBotActive = false; startGame(); };
        document.getElementById('btn-vs-ai').onclick = () => { state.isMultiplayer = false; state.isBotActive = true; startGame(); };
        document.getElementById('btn-battle').onclick = () => startMatchmaking('deathmatch');
        document.getElementById('btn-go-home').onclick = backToHome;
        document.getElementById('btn-save-username').onclick = () => {
            const v = document.getElementById('username-input').value.trim();
            if(v) { state.username = v; localStorage.setItem('oinkUser', v); document.getElementById('ui-username').classList.add('hidden'); }
        };

        requestAnimationFrame(loop);
    </script>
</body>
</html>