<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oink-O-Clock Jump Battle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background: #0f172a;
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        canvas {
            display: block;
            image-rendering: antialiased;
        }
        .ui-layer { pointer-events: none; }
        .ui-layer button, .ui-layer .clickable { pointer-events: auto; }
        .card-item { cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .card-item:hover:not(.locked) { transform: scale(1.02); background: rgba(255, 255, 255, 0.05); }
        .card-item.selected { border-color: #F472B6; background: rgba(244, 114, 182, 0.15); }
        .toast { animation: slide-in-top 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slide-in-top { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .noir-mode { filter: grayscale(100%) contrast(120%); }
        .pig-preview-canvas { width: 64px; height: 64px; display: block; }
        .vs-pulse { animation: vs-pulse 1s infinite alternate; }
        @keyframes vs-pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }
        .ghost-pig { opacity: 0.4; filter: saturate(0.5) brightness(0.8); }
        .searching-dots::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80% { content: '...'; } }
    </style>
</head>
<body>
    <div id="game-container" class="relative shadow-2xl overflow-hidden border-4 border-indigo-900 rounded-3xl bg-indigo-950" style="width: 400px; height: 700px;">
        <canvas id="gameCanvas" width="400" height="700"></canvas>
        
        <!-- Notifications -->
        <div id="toast-container" class="absolute top-4 left-0 right-0 z-[100] px-4 flex flex-col items-center gap-2 pointer-events-none"></div>

        <!-- Home Screen -->
        <div id="ui-home" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950/80 backdrop-blur-sm z-40 text-white p-6 text-center">
            <div id="home-coin-pill" class="absolute top-6 right-6 flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/5">
                <div class="w-4 h-4 bg-yellow-400 rounded-full flex items-center justify-center text-[10px] text-black font-black">‚Çµ</div>
                <div id="home-coins" class="text-sm font-black">0</div>
            </div>

            <div class="mb-6">
                <h1 class="text-5xl font-black mb-1 tracking-tighter text-pink-400 drop-shadow-lg leading-none">OINK BATTLE</h1>
                <p class="text-pink-300/60 font-bold tracking-widest text-[10px] uppercase">Online Swine Showdown</p>
            </div>
            
            <div class="flex flex-col gap-3 w-64 items-center">
                <button onclick="startMatchmaking()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-4 rounded-2xl text-xl transition-all active:scale-95 shadow-xl flex flex-col items-center leading-none">
                    <span>BATTLE ONLINE</span>
                    <span class="text-[9px] opacity-60 mt-1 uppercase tracking-tighter">Real-time Versus Mode</span>
                </button>
                <button onclick="handleMainPlay()" class="w-full bg-pink-500 hover:bg-pink-400 text-white font-black py-3 rounded-2xl text-lg transition-all active:scale-95 shadow-xl uppercase">Solo Practice</button>
                
                <div class="grid grid-cols-2 gap-2 w-full">
                    <button onclick="openSkins()" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl text-[10px] uppercase">SKINS</button>
                    <button onclick="openHats()" class="bg-indigo-800 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl text-[10px] uppercase">HATS</button>
                </div>
            </div>

            <div class="mt-8 group cursor-pointer" onclick="showUsernameEntry()">
                <div id="display-username" class="text-pink-400 font-black text-sm group-hover:underline">Identify Yourself</div>
            </div>
        </div>

        <!-- Matchmaking Overlay -->
        <div id="ui-matchmaking" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950/95 z-[60] text-white p-8 text-center hidden">
            <div class="w-24 h-24 mb-6 relative">
                <div class="absolute inset-0 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-4xl">üê∑</div>
            </div>
            <h2 class="text-2xl font-black mb-2 uppercase italic searching-dots">Finding Opponent</h2>
            <p class="text-xs text-white/40 mb-8 max-w-xs">Scanning for other brave piggies in the time stream...</p>
            <button onclick="cancelMatchmaking()" class="text-[10px] font-bold text-white/30 hover:text-white uppercase tracking-widest border border-white/10 px-6 py-2 rounded-full">Cancel</button>
        </div>

        <!-- Battle Start Screen -->
        <div id="ui-battle-start" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950 z-[70] text-white hidden">
            <div class="flex items-center gap-8 mb-8">
                <div class="flex flex-col items-center">
                    <div class="w-20 h-20 bg-pink-500/20 rounded-2xl border-2 border-pink-500 mb-2 flex items-center justify-center overflow-hidden">
                        <canvas id="p1-preview" width="64" height="64"></canvas>
                    </div>
                    <span id="p1-name" class="font-black text-sm uppercase">YOU</span>
                </div>
                <div class="text-4xl font-black italic text-pink-500 vs-pulse">VS</div>
                <div class="flex flex-col items-center">
                    <div class="w-20 h-20 bg-indigo-500/20 rounded-2xl border-2 border-indigo-500 mb-2 flex items-center justify-center overflow-hidden">
                        <canvas id="p2-preview" width="64" height="64"></canvas>
                    </div>
                    <span id="p2-name" class="font-black text-sm uppercase">RIVAL</span>
                </div>
            </div>
            <h2 id="battle-countdown" class="text-6xl font-black italic">3</h2>
        </div>

        <!-- Shop Menus (Skins/Hats) -->
        <div id="ui-skins" class="absolute inset-0 flex flex-col bg-indigo-950 z-50 text-white p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black uppercase italic tracking-tighter">Skins</h2>
                <button onclick="closeSkins()" class="bg-white/10 p-2 rounded-full">‚úï</button>
            </div>
            <div id="skins-grid" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
        </div>

        <div id="ui-hats" class="absolute inset-0 flex flex-col bg-indigo-950 z-50 text-white p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black uppercase italic tracking-tighter">Hats</h2>
                <button onclick="closeHats()" class="bg-white/10 p-2 rounded-full">‚úï</button>
            </div>
            <div id="hats-grid" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
        </div>

        <!-- HUD -->
        <div id="ui-hud" class="absolute top-0 left-0 right-0 p-4 flex justify-between ui-layer text-white hidden">
            <div class="bg-black/40 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/5">
                <div class="text-[8px] font-bold uppercase opacity-60 tracking-widest mb-0.5">YOU</div>
                <div id="score-val" class="text-3xl font-black text-pink-400 leading-none">0</div>
            </div>
            <div class="bg-black/40 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/5 text-right">
                <div class="text-[8px] font-bold uppercase opacity-60 tracking-widest mb-0.5">OPPONENT</div>
                <div id="opponent-score-val" class="text-3xl font-black text-indigo-400 leading-none">0</div>
            </div>
        </div>

        <!-- Game Over / Results -->
        <div id="ui-gameover" class="absolute inset-0 flex flex-col items-center justify-center bg-red-950/90 backdrop-blur-md z-[55] text-white p-6 text-center hidden">
            <h2 id="battle-result" class="text-5xl font-black mb-1 uppercase tracking-tighter">YOU LOST!</h2>
            <div class="text-7xl font-black text-pink-400 mb-8" id="final-score">0</div>
            <div class="flex flex-col gap-3 w-64 items-center">
                <button onclick="backToHome()" class="bg-white text-indigo-900 font-black py-4 px-12 rounded-xl text-2xl w-full active:scale-95 transition-transform uppercase">HOME</button>
            </div>
        </div>

        <!-- Username Entry -->
        <div id="ui-username" class="absolute inset-0 flex flex-col items-center justify-center bg-indigo-950/95 backdrop-blur-md z-[60] text-white p-6 text-center hidden">
            <h2 class="text-2xl font-black mb-2 uppercase italic">Identify Yourself</h2>
            <input type="text" id="username-input" maxlength="12" placeholder="PIG-NAME" class="w-64 bg-indigo-900 border-2 border-pink-500/30 text-white text-center py-3 rounded-xl font-bold mb-4 focus:outline-none focus:border-pink-500">
            <button onclick="saveUsername()" class="bg-pink-500 text-white font-black py-3 px-12 rounded-xl text-lg transition-transform active:scale-95 w-64 uppercase">CONFIRM</button>
        </div>
    </div>

    <script>
        // Firebase Battle Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBoNeemu9G-sBKPemDxelpCPOuiTZHLyhg",
            authDomain: "gahoot-41e25.firebaseapp.com",
            databaseURL: "https://gahoot-41e25-default-rtdb.firebaseio.com",
            projectId: "gahoot-41e25",
            storageBucket: "gahoot-41e25.firebasestorage.app",
            messagingSenderId: "174472575019",
            appId: "1:174472575019:web:3bd927907334d2ffe1526e",
            measurementId: "G-8QJP2T82VT"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Game Constants
        const WIDTH = 400;
        const HEIGHT = 700;
        const CLOCK_SPACING = 260;
        const JUMP_SPEED = 14;
        const CLOCK_COLORS = ['#F472B6', '#60A5FA', '#34D399', '#FBBF24', '#A78BFA', '#FB923C'];

        // State
        let state = {
            status: 'HOME',
            isMultiplayer: false,
            roomId: null,
            playerId: null, // 'p1' or 'p2'
            score: 0,
            opponentScore: 0,
            coins: parseInt(localStorage.getItem('oinkCoins') || '0'),
            unlockedSkins: JSON.parse(localStorage.getItem('oinkUnlocked') || '["classic"]'),
            selectedSkinId: localStorage.getItem('oinkSkin') || 'classic',
            unlockedHats: JSON.parse(localStorage.getItem('oinkHats') || '["none"]'),
            selectedHatId: localStorage.getItem('oinkHatSelected') || 'none',
            username: localStorage.getItem('oinkUser') || '',
            pig: { x: 200, y: 550, vx: 0, vy: 0, attachedTo: 0, trail: [], coinParticles: [] },
            opponent: { x: 200, y: 550, skin: 'classic', hat: 'none', attachedTo: 0, status: 'playing' },
            clocks: [],
            lastClockId: 0,
            cameraY: 0,
            cameraX: 0,
            lastTime: 0,
            rainbowHue: 0
        };

        const SKINS = [
            { id: 'classic', name: 'Classic Oink', body: '#F472B6', ears: '#EC4899', snout: '#F9A8D4' },
            { id: 'neon', name: 'Neon Hog', body: '#000000', ears: '#3B82F6', snout: '#60A5FA' },
            { id: 'gold', name: 'Gold Swine', body: '#FBBF24', ears: '#D97706', snout: '#FDE68A' },
            { id: 'ghost', name: 'Spectral Pig', body: 'rgba(255,255,255,0.4)', ears: 'rgba(200,200,255,0.3)', snout: 'rgba(255,255,255,0.5)' }
        ];

        const HATS = [
            { id: 'none', name: 'No Hat' },
            { id: 'tophat', name: 'Top Hat' },
            { id: 'viking', name: 'Viking' },
            { id: 'cowboy', name: 'Cowboy' }
        ];

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiHUD = document.getElementById('ui-hud');
        const uiHome = document.getElementById('ui-home');

        let audioCtx;
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playSound(f) {
            if(!audioCtx) return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            o.start(); o.stop(audioCtx.currentTime + 0.1);
        }

        function showToast(m) {
            const t = document.createElement('div');
            t.className = 'toast bg-pink-500 text-white px-6 py-2 rounded-full font-black text-xs shadow-xl';
            t.innerText = m;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        // Multiplayer Logic
        async function startMatchmaking() {
            if (!state.username) return showUsernameEntry();
            state.status = 'MATCHMAKING';
            document.getElementById('ui-matchmaking').classList.remove('hidden');
            
            const queueRef = db.ref('matchmaking_queue');
            queueRef.transaction((currentQueue) => {
                if (!currentQueue) return { [state.username]: Date.now() };
                const players = Object.keys(currentQueue);
                if (players.length > 0) return null; // Someone is there, join them
                return { [state.username]: Date.now() };
            }, (error, committed, snapshot) => {
                if (committed) {
                    // We are hosting
                    waitForOpponent();
                } else {
                    // Someone is already in queue, find them
                    queueRef.once('value', snap => {
                        const players = snap.val();
                        if (players) {
                            const opponentName = Object.keys(players)[0];
                            joinRoom(opponentName + "_vs_" + state.username, 'p2');
                        }
                    });
                }
            });
        }

        function waitForOpponent() {
            const roomCode = state.username + "_wait";
            state.roomId = roomCode;
            db.ref('rooms/' + roomCode).set({
                p1: { name: state.username, skin: state.selectedSkinId, hat: state.selectedHatId, x: 200, y: 550, score: 0 },
                status: 'waiting'
            });
            
            const listener = db.ref('rooms/' + roomCode + '/status').on('value', snap => {
                if (snap.val() === 'playing') {
                    db.ref('rooms/' + roomCode + '/status').off('value', listener);
                    startBattle(roomCode, 'p1');
                }
            });
        }

        function joinRoom(roomCode, role) {
            const hostName = roomCode.split('_vs_')[0];
            const hostWaitCode = hostName + "_wait";
            
            db.ref('rooms/' + hostWaitCode).once('value', snap => {
                const roomData = snap.val();
                const actualRoomCode = hostName + "_vs_" + state.username;
                
                db.ref('rooms/' + actualRoomCode).set({
                    p1: roomData.p1,
                    p2: { name: state.username, skin: state.selectedSkinId, hat: state.selectedHatId, x: 200, y: 550, score: 0 },
                    clocks: generateBattleClocks(),
                    status: 'playing'
                }).then(() => {
                    db.ref('rooms/' + hostWaitCode).update({ status: 'playing' });
                    db.ref('matchmaking_queue').remove();
                    startBattle(actualRoomCode, 'p2');
                });
            });
        }

        function generateBattleClocks() {
            let clocks = [];
            clocks.push({ id: 0, x: 200, y: HEIGHT-150, radius: 60, speed: 0.04, color: CLOCK_COLORS[0] });
            for(let i=1; i<100; i++) {
                const radius = 35 + Math.random() * 50;
                clocks.push({
                    id: i,
                    x: radius + 20 + Math.random() * (WIDTH - radius*2 - 40),
                    y: HEIGHT-150-i*CLOCK_SPACING,
                    radius: radius,
                    speed: (0.04 + (i * 0.0015)) * (60 / radius) * (i % 2 === 0 ? 1 : -1),
                    color: CLOCK_COLORS[i % CLOCK_COLORS.length]
                });
            }
            return clocks;
        }

        function startBattle(roomCode, role) {
            state.status = 'BATTLE_START';
            state.isMultiplayer = true;
            state.roomId = roomCode;
            state.playerId = role;
            
            document.getElementById('ui-matchmaking').classList.add('hidden');
            const uiStart = document.getElementById('ui-battle-start');
            uiStart.classList.remove('hidden');
            
            db.ref('rooms/' + roomCode).once('value', snap => {
                const data = snap.val();
                const oppId = role === 'p1' ? 'p2' : 'p1';
                state.clocks = data.clocks || generateBattleClocks(); // Fallback
                document.getElementById('p1-name').innerText = data[role].name;
                document.getElementById('p2-name').innerText = data[oppId].name;
                
                // Draw previews
                drawPigAvatar(document.getElementById('p1-preview').getContext('2d'), SKINS.find(s=>s.id===data[role].skin), 32, 32, 1, 0, data[role].hat);
                drawPigAvatar(document.getElementById('p2-preview').getContext('2d'), SKINS.find(s=>s.id===data[oppId].skin), 32, 32, 1, 0, data[oppId].hat);
            });

            let count = 3;
            const cd = setInterval(() => {
                count--;
                document.getElementById('battle-countdown').innerText = count;
                if (count <= 0) {
                    clearInterval(cd);
                    uiStart.classList.add('hidden');
                    startGame();
                }
            }, 1000);

            // Live Sync Listener
            const oppId = role === 'p1' ? 'p2' : 'p1';
            db.ref('rooms/' + roomCode + '/' + oppId).on('value', snap => {
                const d = snap.val();
                if (d) {
                    state.opponent.x = d.x;
                    state.opponent.y = d.y;
                    state.opponent.score = d.score;
                    state.opponent.skin = d.skin;
                    state.opponent.hat = d.hat;
                    state.opponent.status = d.status || 'playing';
                    document.getElementById('opponent-score-val').innerText = d.score;
                    if (d.status === 'dead' && state.status === 'PLAYING') {
                        checkWinner();
                    }
                }
            });
        }

        function cancelMatchmaking() {
            db.ref('matchmaking_queue').remove();
            if (state.roomId) db.ref('rooms/' + state.roomId).remove();
            location.reload();
        }

        function startGame() {
            initAudio();
            state.status = 'PLAYING';
            state.score = 0;
            state.cameraY = 0;
            state.cameraX = 0;
            state.lastClockId = 0;
            state.pig = { x: 200, y: HEIGHT-150-60, vx: 0, vy: 0, attachedTo: 0, trail: [], coinParticles: [] };
            if (!state.isMultiplayer) {
                state.clocks = [{ id: 0, x: 200, y: HEIGHT-150, radius: 60, angle: -Math.PI/2, speed: 0.04, color: CLOCK_COLORS[0] }];
                for(let i=1; i<6; i++) state.clocks.push(createSoloClock(i, HEIGHT-150-i*CLOCK_SPACING, i));
            } else {
                // Synchronized clocks are already in state.clocks
                state.clocks.forEach(c => c.angle = -Math.PI/2);
            }
            uiHome.classList.add('hidden');
            uiHUD.classList.remove('hidden');
            refreshUI();
        }

        function createSoloClock(id, y, index) {
            const radius = 35 + Math.random() * 50;
            return { id, x: radius + 20 + Math.random()*(WIDTH - radius*2 - 40), y, radius, angle: -Math.PI/2, speed: 0.04, color: CLOCK_COLORS[index % CLOCK_COLORS.length] };
        }

        function jump() {
            if (state.status !== 'PLAYING' || state.pig.attachedTo === null) return;
            const clock = state.clocks.find(c => c.id === state.pig.attachedTo);
            state.pig.vx = Math.cos(clock.angle) * JUMP_SPEED;
            state.pig.vy = Math.sin(clock.angle) * JUMP_SPEED;
            state.pig.attachedTo = null;
            playSound(440);
        }

        function update(timeScale) {
            if (state.status !== 'PLAYING') return;
            
            state.clocks.forEach(c => c.angle += c.speed * timeScale);

            if (state.pig.attachedTo !== null) {
                const clock = state.clocks.find(c => c.id === state.pig.attachedTo);
                state.pig.x = clock.x + Math.cos(clock.angle) * clock.radius;
                state.pig.y = clock.y + Math.sin(clock.angle) * clock.radius;
            } else {
                state.pig.x += state.pig.vx * timeScale;
                state.pig.y += state.pig.vy * timeScale;
                
                // Collision
                for (const c of state.clocks) {
                    const d = Math.sqrt((state.pig.x-c.x)**2 + (state.pig.y-c.y)**2);
                    if (d < c.radius + 5) {
                        state.pig.attachedTo = c.id;
                        if (c.id > state.lastClockId) {
                            state.score += (c.id - state.lastClockId);
                            state.lastClockId = c.id;
                            document.getElementById('score-val').innerText = state.score;
                        }
                        playSound(220); break;
                    }
                }

                if (state.pig.y > state.cameraY + HEIGHT + 100) gameOver();
            }

            state.cameraY += (state.pig.y - HEIGHT/2 - state.cameraY) * 0.1 * timeScale;
            
            // Multiplayer Sync
            if (state.isMultiplayer) {
                db.ref('rooms/' + state.roomId + '/' + state.playerId).update({
                    x: state.pig.x, y: state.pig.y, score: state.score
                });
            } else {
                const last = state.clocks[state.clocks.length-1];
                if (last.y > state.cameraY - 400) {
                    state.clocks.push(createSoloClock(last.id+1, last.y-CLOCK_SPACING, last.id+1));
                }
            }
        }

        function gameOver() {
            if (state.isMultiplayer) {
                db.ref('rooms/' + state.roomId + '/' + state.playerId).update({ status: 'dead' });
                checkWinner();
            } else {
                state.status = 'GAMEOVER';
                document.getElementById('final-score').innerText = state.score;
                document.getElementById('ui-gameover').classList.remove('hidden');
            }
        }

        function checkWinner() {
            db.ref('rooms/' + state.roomId).once('value', snap => {
                const data = snap.val();
                const p1 = data.p1; const p2 = data.p2;
                if (p1.status === 'dead' && p2.status === 'dead') {
                    const winner = p1.score > p2.score ? p1.name : (p2.score > p1.score ? p2.name : "Draw");
                    showBattleResults(winner);
                } else if (p1.status === 'dead' && state.playerId === 'p2') {
                    // Opponent died, you win if you reach a safe higher score or survive
                    showBattleResults(state.username);
                } else if (p2.status === 'dead' && state.playerId === 'p1') {
                    showBattleResults(state.username);
                }
            });
        }

        function showBattleResults(winner) {
            state.status = 'GAMEOVER';
            const win = winner === state.username;
            document.getElementById('battle-result').innerText = win ? "VICTORY!" : "DEFEATED!";
            document.getElementById('battle-result').className = win ? "text-5xl font-black text-green-400 italic" : "text-5xl font-black text-red-500 italic";
            document.getElementById('final-score').innerText = state.score;
            document.getElementById('ui-gameover').classList.remove('hidden');
        }

        function drawPigAvatar(pctx, skin, x, y, scale = 1, rotation = 0, hatId = 'none') {
            if (!skin) skin = SKINS[0];
            pctx.save(); pctx.translate(x, y); pctx.scale(scale, scale); pctx.rotate(rotation);
            pctx.fillStyle = skin.body; pctx.beginPath(); pctx.ellipse(0, 0, 18, 16, 0, 0, Math.PI*2); pctx.fill();
            pctx.fillStyle = skin.ears; pctx.beginPath(); pctx.moveTo(-14, -10); pctx.lineTo(-18, -20); pctx.lineTo(-6, -14); pctx.fill();
            pctx.beginPath(); pctx.moveTo(14, -10); pctx.lineTo(18, -20); pctx.lineTo(6, -14); pctx.fill();
            pctx.fillStyle = skin.snout; pctx.beginPath(); pctx.ellipse(0, 4, 8, 6, 0, 0, Math.PI*2); pctx.fill();
            pctx.fillStyle = 'black'; pctx.beginPath(); pctx.arc(-7, -4, 2.5, 0, Math.PI*2); pctx.fill();
            pctx.beginPath(); pctx.arc(7, -4, 2.5, 0, Math.PI*2); pctx.fill();
            
            if (hatId !== 'none') {
                pctx.fillStyle = '#000';
                if (hatId === 'tophat') pctx.fillRect(-10, -25, 20, 15);
                if (hatId === 'viking') { pctx.beginPath(); pctx.arc(0, -12, 10, Math.PI, 0); pctx.fill(); }
            }
            pctx.restore();
        }

        function draw() {
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,WIDTH,HEIGHT);
            ctx.save(); ctx.translate(-state.cameraX, -state.cameraY);
            
            // Clocks
            state.clocks.forEach(c => {
                ctx.beginPath(); ctx.arc(c.x, c.y, c.radius, 0, Math.PI*2); ctx.strokeStyle = c.color; ctx.lineWidth = 6; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x, c.y); ctx.lineTo(c.x + Math.cos(c.angle)*c.radius, c.y + Math.sin(c.angle)*c.radius); ctx.strokeStyle = c.color; ctx.lineWidth = 8; ctx.stroke();
            });

            // Self
            const mySkin = SKINS.find(s=>s.id===state.selectedSkinId);
            drawPigAvatar(ctx, mySkin, state.pig.x, state.pig.y, 1, 0, state.selectedHatId);

            // Opponent
            if (state.isMultiplayer) {
                const oppSkin = SKINS.find(s=>s.id===state.opponent.skin);
                ctx.globalAlpha = 0.5;
                drawPigAvatar(ctx, oppSkin, state.opponent.x, state.opponent.y, 1, 0, state.opponent.hat);
                ctx.globalAlpha = 1.0;
                ctx.fillStyle = '#60A5FA'; ctx.font = 'black 8px Inter'; ctx.textAlign = 'center';
                ctx.fillText(state.opponent.score, state.opponent.x, state.opponent.y - 30);
            }

            ctx.restore();
        }

        function loop(timestamp) {
            if (!state.lastTime) state.lastTime = timestamp;
            const timeScale = Math.min(timestamp - state.lastTime, 100) / 16.66;
            state.lastTime = timestamp;
            update(timeScale);
            draw();
            requestAnimationFrame(loop);
        }

        function handleMainPlay() { state.isMultiplayer = false; startGame(); }
        function backToHome() { location.reload(); }
        function showUsernameEntry() { document.getElementById('ui-username').classList.remove('hidden'); }
        function saveUsername() {
            const v = document.getElementById('username-input').value.trim();
            if (v.length < 2) return;
            state.username = v; localStorage.setItem('oinkUser', v);
            document.getElementById('ui-username').classList.add('hidden');
            refreshUI();
        }

        function refreshUI() {
            document.getElementById('home-coins').innerText = state.coins;
            document.getElementById('display-username').innerText = state.username || 'Identify Yourself';
        }

        canvas.addEventListener('mousedown', () => { initAudio(); jump(); });
        requestAnimationFrame(loop);
        refreshUI();
    </script>
</body>
</html>